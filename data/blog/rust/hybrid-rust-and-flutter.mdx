---
title: 'Rust ä¸ Flutter æ··åˆå¼€å‘'
date: 2022-10-19
tags: ['rust', 'flutter']
summary: 'æœ¬æ–‡è®²è¿° Rust ä»£ç æ˜¯å¦‚ä½•ä¸å¸¸è§çš„ App å¹³å°é›†æˆï¼Œè¿™äº›å¹³å°åŒ…æ‹¬ iOSã€Androidã€MacOSã€Windowsã€Linux ä»¥åŠ Webã€‚'
---

> ä¸æœ¬æ–‡ç›¸å…³ç³»åˆ—çš„æ–‡ç« é˜…è¯»é¡ºåº
>
> 1. **Rust ä¸ Flutter æ··åˆå¼€å‘ï¼ˆæœ¬æ–‡ï¼‰**
> 2. [Rust ä¸ Dart çš„æ•°æ®äº¤äº’](../flutter/rust-and-dart-interop)

<TOCInline toc={props.toc} asDisclosure />

éšç€ä¸°å¯Œçš„ç»ˆç«¯äº§å“çš„å‡ºç°ï¼Œè·¨å¹³å°çš„éœ€æ±‚ä¹Ÿéšä¹‹å‡ºç°ï¼ŒJava æ›¾å‡­ç€ã€Œä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œï¼ˆ**Write once, run anywhere**ã€**WORA**ã€çš„å£å·å¿«é€Ÿæå‡å¸‚åœºå æœ‰ç‡ã€‚

ä¸ºäº†å‡å°‘ App å¼€å‘æˆæœ¬ï¼Œå¤§å¤šæ•°è½¯ä»¶éƒ½ä¼šé€‰æ‹©è·¨å¹³å°æŠ€æœ¯ï¼Œä¾‹å¦‚æ¡Œé¢ç«¯å¸¸è§çš„ Electronï¼Œç§»åŠ¨ç«¯å¸¸è§çš„ React Native å’Œ Flutterã€‚

æ­¤ç±»æ¡†æ¶æå‡äº†è·¨å¹³å° App å¼€å‘çš„ä¸‹é™ï¼Œä½†ä¹Ÿé™åˆ¶äº†ä¸Šé™ã€‚å¯¹äºç”¨æˆ·ä½“éªŒè¦æ±‚æé«˜çš„åœºæ™¯ï¼Œè¿™ä¼šæˆä¸ºç“¶é¢ˆï¼Œå› æ­¤åˆéœ€è¦ç”¨å„å¹³å°çš„åŸç”Ÿ UI æ¡†æ¶å®ç°ã€‚è¿™æ ·å…¨é¢æˆ–è€…å±€éƒ¨é‡‡ç”¨åŸç”Ÿå¼€å‘ï¼Œå°†ç”±å¼€å‘äººå‘˜æ‰¿æ‹…è·¨å¹³å°çš„æˆæœ¬ï¼Œå³å¯¹äºåŒæ ·é¡µé¢çš„éœ€æ±‚ï¼Œåœ¨ä¸åŒå¹³å°é‡‡ç”¨ä¸åŒè¯­è¨€å»å¤šæ¬¡å®ç°ã€‚

ä¸ºäº†å…±äº«é€šç”¨é€»è¾‘ï¼ŒKotlin æ¨å‡ºäº† [Kotlin Multiplatform Mobile (KMM) ](https://kotlinlang.org/lp/mobile/) ï¼Œå®ƒçš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="/static/images/rust/hybrid-rust-and-flutter/kmm.png" width="500px" alt="KMM" />

KMM ä»å®˜ç½‘çš„ä»‹ç»çœ‹ï¼Œä¹Ÿèƒ½å¤Ÿæ”¯æŒå„ç§åŒ…æ‹¬æ¡Œé¢ç«¯ï¼Œç§»åŠ¨ç«¯å’Œä¾¿æºè®¾å¤‡åœ¨å†…çš„å¤šå¹³å°ï¼Œä¸è¿‡ç°åœ¨æˆ‘ä»¬å…³æ³¨çš„æ˜¯å¦ä¸€ä¸ªæ–¹æ¡ˆï¼Œç”± Rust æˆ–è€… C/C++ ä½œä¸ºä¸šåŠ¡é€»è¾‘å±‚çš„è·¨å¹³å°æ–¹æ¡ˆï¼Œä¸‹å›¾å±•ç¤ºäº†å…¶æ¶æ„ï¼Œæœ¬è´¨ä¸Šå’Œ KMM ä¸€æ ·ã€‚

![hybrid-rust-and-flutter](/static/images/rust/hybrid-rust-and-flutter/rust+flutter_framework.svg?w=700)

è¿™é‡Œçš„ä¸¤å±‚å’Œ KMM ä¸­å±•ç¤ºçš„ä¸¤å±‚ä½œç”¨ä¸€è‡´ï¼ŒRust é€šè¿‡ç¼–è¯‘å‡ºå„ä¸ªå¹³å°çš„é™æ€æˆ–è€…åŠ¨æ€åº“ï¼Œä¾›åŸç”Ÿå·¥ç¨‹ä½¿ç”¨ï¼Œå”¯ä¸€ä¾‹å¤–çš„æ˜¯ Web ç«¯æ˜¯é€šè¿‡ WebAssembly æ”¯æŒçš„ã€‚

å›¾ä¸­çš„ UI åˆ—å‡ºäº†å„å¹³å°å¯èƒ½ä½¿ç”¨çš„åŸç”Ÿ UI æ¡†æ¶ï¼Œå½“ç„¶è¿™äº›æ¡†æ¶ä¹Ÿå¯ä»¥æ›¿æ¢æˆ Flutterï¼Œç”šè‡³æ˜¯ Flutter å’ŒåŸç”Ÿ UI æ¡†æ¶æ··åˆã€‚UI ä»…è´Ÿè´£ç¼–å†™ App é¡µé¢ï¼Œå…¶ä½™å·¥ä½œäº¤ç»™ä¸‹å±‚çš„ä¸šåŠ¡é€»è¾‘å’Œæ ¸å¿ƒé€»è¾‘ã€‚

**ä¸šåŠ¡é€»è¾‘å’Œæ ¸å¿ƒ**è´Ÿè´£ä¸šåŠ¡é€»è¾‘å’Œç»´æŠ¤æ•°æ®ç­‰ä¸ UI æ— å…³çš„å·¥ä½œï¼Œåªè¦èƒ½å¤Ÿç¼–è¯‘å‡ºå„ä¸ªå¹³å°çš„åº“çš„è¯­è¨€éƒ½å¯ä»¥ä½œä¸ºè¯¥å±‚çš„ç¼–ç¨‹è¯­è¨€ã€‚æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ Rust ç¼–å†™æ˜¯å› ä¸ºå®ƒæ‹¥æœ‰å’Œ C/C++ ä¸€æ ·çš„å¹¿æ³›ç”¨é€”ï¼Œä»¥åŠé«˜æ•ˆçš„è¿è¡Œå’Œå†…å­˜æ•ˆç‡ï¼Œæ­¤å¤–è¿˜æ‹¥æœ‰ C/C++ æ²¡æœ‰çš„ä¼˜åŠ¿ â€”â€” å®‰å…¨ã€‚

## å®ç°åŸç†

åœ¨åº”ç”¨ç¨‹åºå¼€å‘ä¸­ï¼ŒABIï¼ˆApplication Binary Interfaceï¼‰æ˜¯ä¸¤ä¸ªäºŒè¿›åˆ¶ç¨‹åºä¹‹é—´çš„æ¥å£ï¼Œä¸€ä¸ª ABI å®šä¹‰äº†æœºå™¨ç å¦‚ä½•å­˜å–æ•°æ®ç»“æ„å’Œè¿ç®—ç¨‹åºï¼Œæœºå™¨ç æ˜¯ä¸€ç§ä½çº§çš„ï¼Œä¾èµ–äºç¡¬ä»¶çš„æ ¼å¼ã€‚ä¸æ­¤ç›¸åï¼ŒAPI åœ¨æºä»£ç ä¸­å®šä¹‰äº†è¿™ç§è®¿é—®ï¼Œè¿™æ˜¯ä¸€ç§ç›¸å¯¹é«˜çº§çš„ï¼Œä¸ç¡¬ä»¶æ— å…³çš„ã€é€šå¸¸æ˜¯äººç±»å¯è¯»çš„æ ¼å¼ã€‚

æœ¯è¯­ FFIï¼ˆForeign function interfaceï¼‰æ¥è‡ªäº Common Lisp è§„èŒƒï¼Œè¯¥è§„èŒƒæ˜ç¡®æåˆ°äº†è·¨è¯­è¨€è°ƒç”¨çš„è¯­è¨€ç‰¹æ€§ã€‚å…¶ä»–è¯­è¨€ä¹Ÿè®¸æœ‰ä¸åŒçš„ç§°è°“ï¼Œä¾‹å¦‚ Java å°† FFI ç§°ä¸º JNIï¼ˆJava Native Interfaceï¼‰ï¼Œä½† FFI è¢«æ›´å¤šè¯­è¨€æ‰€æ¥å—ï¼Œå·²ç»æˆä¸ºæä¾›æ­¤ç±»æœåŠ¡çš„æœºåˆ¶çš„é€šç”¨æœ¯è¯­ã€‚

FFI çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼ˆhost è¯­è¨€ï¼Œæˆ–å®šä¹‰ FFI çš„è¯­è¨€ï¼‰çš„è¯­ä¹‰å’Œè°ƒç”¨ä¹ æƒ¯ä¸å¦ä¸€ç§è¯­è¨€ï¼ˆguest è¯­è¨€ï¼‰çš„è¯­ä¹‰å’Œä¹ æƒ¯ç›¸åŒ¹é…ã€‚è¿™ä¸ªè¿‡ç¨‹è¿˜å¿…é¡»è€ƒè™‘åˆ°ä¸¤è€…çš„è¿è¡Œç¯å¢ƒå’Œ ABIã€‚åé¢ä¼šçœ‹åˆ° Rust äºæ­¤ç›¸å…³çš„å·¥å…·é“¾çš„ä½¿ç”¨æ–¹å¼ã€‚

ä¸‹æ–‡æè¿°äº† Rust ä»£ç æ˜¯å¦‚ä½•ä¸å¸¸è§çš„ App å¹³å°é›†æˆï¼Œè¿™äº›å¹³å°åŒ…æ‹¬ iOSã€Androidã€MacOSã€Windowsã€Linux ä»¥åŠ Webã€‚ç¤ºä¾‹æ˜¯åœ¨ Rust ä¸­æä¾› md5 è®¡ç®—æ¥å£ï¼Œåœ¨ Flutter ä¸­è°ƒç”¨ã€‚

## åˆ›å»ºé¡¹ç›®

æœ¬æ–‡çš„ä»£ç å±äº hello world çº§ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­å»ºè®®ä½¿ç”¨é¢„é…ç½®çš„æ¨¡æ¿ï¼Œå·¥å…·åŒ–çš„å·¥ä½œæµèƒ½å¤ŸèŠ‚çœå¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚å‚è§ [flutter_rust_bridge](https://cjycode.com/flutter_rust_bridge/)ã€‚

:::tip ç¯å¢ƒæ¸…å•
rustc 1.63.0-nightly & Flutter 3.3.4 â€¢ channel stable è¿è¡Œäº MacBookPro M1ã€‚
:::

è¿è¡Œä¸‹åˆ—å‘½ä»¤åˆ›å»º Flutter é¡¹ç›®ï¼š

```shell
flutter create demo
```

è¿›å…¥ Flutter é¡¹ç›®ç›®å½•ï¼Œåˆ›å»ºåä¸º _native_ çš„ Rust é¡¹ç›®ï¼š

```shell
cd demo
cargo new --lib native
```

è¿›å…¥ _native_ ç›®å½•ï¼Œä¿®æ”¹ _Cargo.toml_ï¼Œä¸º Rust é¡¹ç›®æŒ‡å®š `crate-type`ï¼š

```
[lib]
crate-type = ["cdylib", "staticlib"]
```

é™æ€åº“ç”¨äº iOSï¼ŒåŠ¨æ€åº“ç”¨äºå…¶ä»–å¹³å°ã€‚

## å®ç° md5

è®¡ç®— md5 å°†ç›´æ¥ä½¿ç”¨ [md5](https://crates.io/crates/md5) crateï¼Œè¿è¡Œå‘½ä»¤æ·»åŠ ä¾èµ–ï¼š

```shell
cd native
cargo add md5
```

åˆ é™¤ _src/lib.rs_ ä¸­çš„é»˜è®¤ä»£ç ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

```rust
use std::ffi::{c_char, CString, CStr};

#[no_mangle]
pub extern "C" fn md5(data: *const c_char) -> *mut c_char {
    let cstr = unsafe { CStr::from_ptr(data)};
    let rstr = String::from_utf8_lossy(cstr.to_bytes()).to_string();
    let digest = md5::compute(rstr);
    CString::new(format!("{:x}", digest)).unwrap().into_raw()
}
```

å‡½æ•°çš„è¾“å…¥è¾“å‡ºç±»å‹ä½¿ç”¨çš„æ˜¯ `*const c_char` å’Œ `*mut c_char`ï¼Œåœ¨å‡½æ•°ä½“ä¸­ä¼šè¢«è½¬æ¢æˆå¯¹åº”çš„ `CStr` å’Œ `CString`ï¼Œå› ä¸º Rust String å’Œ C String çš„è§„åˆ™ä¸ä¸€è‡´ï¼Œä¾‹å¦‚ Rust ä½¿ç”¨ UTF8 ç¼–ç ï¼Œè€Œ C String æœ‰å¤šç§ç¼–ç ï¼Œæˆ–æ˜¯ C String æ˜¯ Null-Terminated Stringï¼Œè€Œ Rust String ä¸æ˜¯ã€‚

`CStr` ä¹‹äº `CString` çŠ¹å¦‚ `&str` ä¹‹äº `String`ã€‚`CStr` æ˜¯ä¸€æ®µå­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œä¸æ‹¥æœ‰æ‰€æœ‰æƒï¼Œ`CString` æ‹¥æœ‰æ‰€æœ‰æƒã€‚å› æ­¤å°† Rust String è½¬æ¢ä¸º C String ä¼šç”¨åˆ° `CString`ï¼Œå°† C String è½¬æ¢ä¸º Rust String ä¼šç”¨åˆ° `CStr`ï¼Œæ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒ [Rust FFI](https://doc.rust-lang.org/std/ffi/index.html) æ–‡æ¡£ã€‚

`extern "C"` æŒ‡å®šä½¿ç”¨ C ABIï¼Œä¹Ÿå¯ä»¥çœç•¥ `"C"`ï¼Œå®ƒæ˜¯é»˜è®¤å€¼ã€‚`no_mangle` å±æ€§å…³é—­ Rust ç¼–è¯‘å™¨çš„å‘½åæ··æ·†ï¼Œä½¿å®ƒèƒ½å¤Ÿè¢«é“¾æ¥å™¨è¯†åˆ«ã€‚è¿™æ˜¯æ¯ä¸ªè¦æš´éœ²çš„æ¥å£éœ€è¦è¿›è¡Œçš„è®¾ç½®ã€‚æ›´å¤šç»†èŠ‚å‚è§ [Rust ä¸ Dart çš„æ•°æ®äº¤äº’](./rust-and-dart-interop)ã€‚

## ç”Ÿæˆ C å¤´æ–‡ä»¶

[cbindgen](https://docs.rs/crate/cbindgen/latest) ç”¨äºä¸ºå¯¼å‡º C API çš„ Rust åº“ç”Ÿæˆ C/C++11 å¤´æ–‡ä»¶ã€‚è¿è¡Œä¸‹åˆ—å‘½ä»¤å®‰è£… cbindgenï¼š

```shell
cargo install cbindgen
```

åˆ›å»º `cbindgen.toml`ï¼Œå†…å®¹å¯ä»¥ä»[æ¨¡æ¿](https://github.com/eqrion/cbindgen/blob/master/template.toml)ä¸­å¤åˆ¶ï¼Œå°† `no_includes` çš„å€¼æ”¹ä¸º `true`ï¼Œå¹¶å°† `language` æ”¹ä¸º `"C"`ï¼Œå› ä¸ºä¸‹æ–‡ä½¿ç”¨çš„ ffigen åªèƒ½è¯†åˆ« C headerã€‚è¿è¡Œ cbindgen ç”Ÿæˆå¤´æ–‡ä»¶ï¼š

```shell
mkdir -p target
cbindgen src/lib.rs -c cbindgen.toml > target/bindings.h
```

å› ä¸ºåªæœ‰ä¸€ä¸ª `md5` å‡½æ•°ï¼Œæ‰€ä»¥ç”Ÿæˆçš„ _bindings.h_ ä¹Ÿæ¯”è¾ƒç®€å•ï¼š

```c
extern "C" {

char *md5(const char *data);

} // extern "C"
```

## ä¸º Dart ç”Ÿæˆ FFI API

Dart ä¸ FFI ç›¸å…³çš„åŒ…æœ‰ `dart:ffi` æä¾›è°ƒç”¨ C APIï¼Œè¯»/å†™ã€åˆ†é…/é‡Šæ”¾åŸç”Ÿå†…å­˜ ï¼Œ[ffi](https://pub.dev/packages/ffi) æä¾› Dart String å’Œ C String çš„è½¬æ¢ã€‚[ffigen](https://pub.dev/packages/ffigen) ç”¨äºç”Ÿæˆä»£ç ã€‚

å›åˆ° Flutter é¡¹ç›®ç›®å½•ï¼Œæ·»åŠ ä¾èµ–ï¼š

```shell
flutter pub add ffi ffigen
```

æ‰“å¼€ _pubspec.yaml_ï¼Œæ·»åŠ  ffigen é…ç½®ï¼š

```yaml
ffigen:
  output: 'lib/generated_bindings.dart'
  description: 'Demonstration of flutter calling rust functions'
  headers:
    entry-points:
      - 'native/target/bindings.h'
  name: 'FlutterRustBindings'
```

æ‰§è¡Œ `flutter pub run ffigen`ï¼Œç”Ÿæˆ _lib/generated_bindings.dart_ã€‚å¦‚æœç¢°åˆ°é—®é¢˜å¯ä»¥æŸ¥çœ‹ [ffigen](https://pub.dev/packages/ffigen) æ–‡æ¡£æŸ¥çœ‹ä¾èµ–ã€‚æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç å¯ä»¥çœ‹åˆ°ä¹‹å‰åœ¨ Rust å®ç°çš„ md5 å‡½æ•°ï¼š

```dart
ffi.Pointer<ffi.Char> md5(ffi.Pointer<ffi.Char> data);
```

å®ƒçš„è¾“å…¥è¾“å‡ºå…¨æ˜¯æŒ‡é’ˆï¼Œä¸ºäº†æ›´ç®€å•çš„ä½¿ç”¨ï¼Œæœ€å¥½è¿›è¡Œä¸€å±‚å°è£…ï¼Œåˆ›å»º _lib/api.dart_ï¼Œæ·»åŠ ä»£ç ï¼š

```dart
import 'dart:ffi';
import 'dart:io';

import 'package:ffi/ffi.dart';

import 'generated_bindings.dart';

class FlutterRust {
  static final FlutterRustBindings _bindings =
      FlutterRustBindings(_loadLibrary());

  static DynamicLibrary _loadLibrary() {
    if (Platform.isIOS || Platform.isMacOS) {
      return DynamicLibrary.executable();
    } else if (Platform.isWindows) {
      return DynamicLibrary.open("native.dll");
    } else {
      return DynamicLibrary.open("libnative.so");
    }
  }

  static String md5(String value) {
    return _bindings
        .md5(value.toNativeUtf8().cast<Char>())
        .cast<Utf8>()
        .toDartString();
  }
}
```

å¯¹äºä¸åŒæ“ä½œç³»ç»Ÿï¼ŒåŠ è½½åº“è°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸ä¸€æ ·çš„ã€‚

## ä¿®æ”¹ Flutter ä»£ç 

ä¸ºäº†åœ¨ Flutter ä¸­è°ƒç”¨ `md5` å¹¶æ˜¾ç¤ºï¼Œå¯¹ Flutter é»˜è®¤ç”Ÿæˆçš„é¡¹ç›®è¿›è¡Œå¾®å°çš„ä¿®æ”¹ï¼ŒæŠŠ `build` å‡½æ•°ä½“ä¸­ `Center` ç»„ä»¶çš„ `child` æ›¿æ¢ä¸º `Text(FlutterRust.md5("hello world"))`ã€‚æ­¤æ—¶é—ç•™çš„ä¸€äº›ä»£ç å¯ä»¥è‡ªè¡Œåˆ å»ï¼Œä¸åˆ ä¹Ÿä¸å½±å“ã€‚

## é…ç½® iOS é¡¹ç›®

æœ‰å¤šç§æ–¹å¼å¯ä»¥é…ç½® iOS é¡¹ç›®ï¼Œå‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæœ¬èŠ‚é‡‡ç”¨çš„æ–¹å¼æ˜¯åœ¨ XCode ä¸­æ‰‹åŠ¨å®Œæˆé…ç½®ã€‚

:::warning
åœ¨ M ç³»åˆ— CPU çš„ Mac ç”µè„‘ä¸Šï¼Œä½¿ç”¨æ¨¡æ‹Ÿå™¨å°±å¯ä»¥è¿è¡Œï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯ Intel CPU çš„ Mac ç”µè„‘ï¼Œæ— æ³•ä½¿ç”¨æ¨¡æ‹Ÿå™¨è¿è¡Œï¼Œè¯·ä½¿ç”¨çœŸæœºã€‚
:::

### ä¿®æ”¹ iOS é¡¹ç›®ç­¾å

1.  åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰“å¼€ _ios/Runner.xcworkspace_
2.  åœ¨ Project Navigator é€‰ä¸­ Runner
3.  åˆ‡æ¢åˆ° Signing & Capabilities é¡µç­¾
4.  é€‰æ‹©ä¸€ä¸ªå›¢é˜Ÿ
5.  ä¿®æ”¹ Bundle Identifier æˆå”¯ä¸€çš„ ID

### ç¼–è¯‘ Rust ä»£ç 

ä¸º Rust æ·»åŠ  iOS ç¼–è¯‘ç›®æ ‡ï¼š

```shell
rustup target add aarch64-apple-ios
rustup target add aarch64-apple-ios-sim
```

è¿›å…¥ _native_ ç›®å½•ï¼Œç¼–è¯‘ Rust ä»£ç ï¼š

```shell
cargo build --target aarch64-apple-ios --release
# è¿›å…¥è¾“å‡ºæ–‡ä»¶å¤¹
cd target/aarch64-apple-ios/release
# åˆ é™¤æ²¡ç”¨çš„æ–‡ä»¶
rm -rf `ls | grep -v "libnative.a"`
# å›åˆ° native æ–‡ä»¶å¤¹
cd -
```

ç¼–è¯‘åçš„æ–‡ä»¶ä½äº _target/TARGET_TRIPLE/release_ï¼Œå¯¹äº iOS æ¥è¯´ï¼Œåªéœ€è¦é™æ€åº“ï¼Œç”±äºä¿ç•™åŠ¨æ€åº“ä¼šè®©ç¼–è¯‘æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ é™¤äº†æ²¡ç”¨çš„æ–‡ä»¶ã€‚

å¦‚æœæ˜¯åœ¨æ¨¡æ‹Ÿå™¨è¿è¡Œï¼Œéœ€è¦æŠŠ target æ”¹ä¸º `aarch64-apple-ios-sim`ï¼Œæœ¬èŠ‚ç¤ºä¾‹ä½¿ç”¨çš„æ˜¯çœŸæœºè°ƒè¯•ã€‚

### é…ç½® XCode

1. åœ¨ **Project Navigator** é€‰ä¸­ **Runner**
2. åˆ‡æ¢åˆ° **Build Phases** é¡µç­¾ï¼Œå±•å¼€ **Link Binary With Libraries**
3. æŠŠä¹‹å‰ç¼–è¯‘çš„ _target/aarch64-apple-ios/release/libnative.a_ æ‹–åŠ¨åˆ°æ­¤åŒºåŸŸ
4. åˆ‡æ¢åˆ° **Build Settings** é¡µç­¾ï¼Œæ‰¾åˆ° **Library Search Paths**ï¼ŒåŒå‡»æ‰“å¼€ï¼Œå¹¶æ‹–å…¥ _target/aarch64-apple-ios/release_ æ–‡ä»¶å¤¹
5. æ‰¾åˆ° **Header Search Paths**ï¼ŒåŒå‡»æ‰“å¼€ï¼Œå¹¶æ‹–å…¥ _target_ æ–‡ä»¶å¤¹
6. ç‚¹å‡»èœå• File -> Add Files to "Runner"ï¼Œé€‰æ‹© _target_ æ–‡ä»¶å¤¹ä¸­çš„ _bindings.h_
7. æ‰“å¼€ Runner ä¸‹çš„ _Runner-Bridging-Header.h_ æ–‡ä»¶ï¼Œæ·»åŠ ä¸€è¡Œä»£ç ï¼š

```objective-c
#import "bindings.h"
```

### è§£å†³æ— æ³•æ‰¾åˆ° symbol

æ­¤æ—¶è¿è¡Œ Flutter é¡¹ç›®èƒ½å¤Ÿç¼–è¯‘é€šè¿‡ï¼Œä½†æ˜¯ä¼šæç¤º `Failed to lookup symbol 'md5'`ã€‚

å¦‚æœæˆ‘ä»¬æ˜¯åŸç”Ÿé¡¹ç›®ï¼Œè€Œä¸æ˜¯ Flutter é¡¹ç›®ï¼Œé‚£ä¹ˆè°ƒç”¨ Rust ä»£ç æ˜¯åœ¨ Swift ç¼–å†™çš„ï¼Œè€Œç°åœ¨ç”±äºæ˜¯ Flutter é¡¹ç›®ï¼Œä»£ç æ˜¯ Dart å†™çš„ã€‚è¿™å¯¼è‡´äº†ä¸€ç§æƒ…å†µï¼Œç”±äº Swift æ²¡æœ‰è°ƒç”¨ Rust çš„é‚£äº›æ¥å£ï¼Œå¯¼è‡´ç¼–è¯‘å™¨ä¼˜åŒ–äº†è¿™éƒ¨åˆ†ç¬¦å·ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Swift å¼•ç”¨ä¸‹æ¥å£ã€‚

1. æ‰“å¼€ _AppDelegate.swift_
2. æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```swift
public func dummyMethodToEnforeBunding() {
    md5("")
}
```

ä¸Šè¿°ä»£ç åªæ˜¯å¼•ç”¨äº†ï¼Œæ²¡æœ‰å®é™…è°ƒç”¨ FFI æ¥å£ã€‚

æ­¤æ—¶è¿è¡Œ `flutter run -d YOUR_IPHONE_UDID` ï¼Œå¯ä»¥æˆåŠŸçœ‹åˆ°ç”»é¢äº†ã€‚

<img
  src="/static/images/rust/hybrid-rust-and-flutter/run-on-iphone.png"
  width="250px"
  alt="run on iphone"
/>

## é…ç½® Android é¡¹ç›®

:::tip
ç¡®ä¿å®‰è£…äº† Android NDK 22ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨äº† NDK 23+ï¼Œè¯·ç•™æ„ä¸‹ä¸€èŠ‚çš„å†…å®¹ï¼Œå¦åˆ™å¯ä»¥è·³è¿‡ã€‚
:::

### ä½¿ç”¨ NDK 23+

ç”±äºæ­¤ [issue](https://github.com/rust-lang/rust/pull/85806) æè¿°çš„é—®é¢˜ï¼Œä½¿ç”¨ NDK 23+ éœ€è¦å¯¹ NDK ä¸­çš„æ–‡ä»¶è¿›è¡Œä¸€äº›ä¿®æ”¹æ‰èƒ½ç¼–è¯‘ï¼Œå¦‚æœä½¿ç”¨ NDK 22 å¯ä»¥è·³è¿‡è¿™ä¸ªæ­¥éª¤ã€‚

è¿›å…¥ NDK çš„ç›®å½•ä¸‹æŸ¥æ‰¾ _libunwind.a_ æ–‡ä»¶ï¼š

```shell
$ find . -name libunwind.a
./toolchains/llvm/prebuilt/darwin-x86_64/lib64/clang/12.0.8/lib/linux/i386/libunwind.a
./toolchains/llvm/prebuilt/darwin-x86_64/lib64/clang/12.0.8/lib/linux/arm/libunwind.a
./toolchains/llvm/prebuilt/darwin-x86_64/lib64/clang/12.0.8/lib/linux/aarch64/libunwind.a
./toolchains/llvm/prebuilt/darwin-x86_64/lib64/clang/12.0.8/lib/linux/x86_64/libunwind.a
```

æ‰¾åˆ°äº† 4 ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«å¯¹åº” 4 ä¸ª ABIã€‚æœ¬ç¤ºä¾‹è¿è¡Œçš„å®¿ä¸»æœºæ˜¯ M1 èŠ¯ç‰‡çš„ MacBook Proï¼Œä½¿ç”¨çš„è®¾å¤‡æ˜¯ Android æ¨¡æ‹Ÿå™¨ï¼ŒM1 çš„ Android æ¨¡æ‹Ÿå™¨æ¶æ„æ˜¯ Arm64ï¼Œtarget triple æ˜¯ `aarch64-linux-android`ã€‚æ‰€ä»¥éœ€è¦ä¿®æ”¹çš„ ABI æ˜¯ `aarch64`ï¼Œæ›´å¤šçš„å¯¹åº”å…³ç³»å¯ä»¥æŸ¥çœ‹ä¸‹è¡¨ï¼š

| ABI         | triple                     |
| ----------- | -------------------------- |
| armeabi-v7a | `armv7a-linux-androideabi` |
| arm64-v8a   | `aarch64-linux-android`    |
| x86         | `i686-linux-android`       |
| x86-64      | `x86_64-linux-android`     |

è¿›å…¥ _aarch64_ ç›®å½•ï¼Œæ‰§è¡Œï¼š

```shell
cat << EOF > libgcc.a
INPUT(-lunwind)
EOF
```

### ç¼–è¯‘ so

è¿›å…¥ _native_ ç›®å½•ï¼Œåˆ›å»ºæ–‡ä»¶ _.cargo/config_ï¼Œæ­¤æ–‡ä»¶ç”¨äº cargo ç¼–è¯‘çš„é…ç½®ã€‚æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```yaml
[target.aarch64-linux-android]
linker = "<PATH_TO_NDK>/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android26-clang"

[target.armv7-linux-androideabi]
linker = "<PATH_TO_NDK>/toolchains/llvm/prebuilt/darwin-x86_64/bin/armv7a-linux-androideabi29-clang"
```

ä¸Šä¾‹æ·»åŠ äº†ä¸¤æ¡é…ç½®ã€‚å¦‚å‰æ–‡æ‰€å±ï¼Œç¬”è€…ä½¿ç”¨çš„ ABI æ˜¯ `aarch64-linux-android`ï¼Œå¯¹åº”ç€ç¬¬ä¸€æ¡é…ç½®ï¼Œå¦ä¸€ä¸ªå¸¸ç”¨çš„ `armv7a-linux-androideabi` æ˜¯ç¬¬äºŒæ¡ï¼Œæ­¤å¤„ä½œä¸ºç¤ºä¾‹ã€‚ä¸åŒçš„ CPU æ¶æ„ã€ä¸åŒçš„æ“ä½œç³»ç»Ÿè¯·æŒ‰ç…§ä¸Šè¿°ç¤ºä¾‹è§„åˆ™æ·»åŠ é…ç½®ã€‚

è¿è¡Œå‘½ä»¤ç¼–è¯‘åŠ¨æ€åº“ï¼š

```shell
cargo build --target=aarch64-linux-android --release
```

åœ¨ Android é¡¹ç›®ä¸­åˆ›å»ºå­˜æ”¾åŠ¨æ€é“¾æ¥åº“çš„ç›®å½•ï¼Œå¹¶å°†ç¼–è¯‘äº§ç‰©å¤åˆ¶è¿‡å»ï¼š

```
mkdir -p ../android/app/src/main/jniLibs/
mkdir -p ../android/app/src/main/jniLibs/arm64-v8a
# å¤åˆ¶ç¼–è¯‘äº§ç‰©
cp target/aarch64-linux-android/release/libnative.so ../android/app/src/main/jniLibs/arm64-v8a/
```

### è¿è¡Œ

æ‰§è¡Œ `flutter run -d YOUR_ANDROID_ID` ï¼Œå¯ä»¥æˆåŠŸçœ‹åˆ°ç”»é¢äº†ã€‚

<img
  src="/static/images/rust/hybrid-rust-and-flutter/run-on-android.png"
  width="250px"
  alt="run on android"
/>

## é…ç½® MacOS é¡¹ç›®

### ç¼–è¯‘ Rust ä»£ç 

ä¸º Rust æ·»åŠ  MacOS çš„ç¼–è¯‘ç›®æ ‡ï¼š

```shell
rustup target add aarch64-apple-darwin
rustup target add x86_64-apple-darwin
```

M1 èŠ¯ç‰‡é€‰æ‹©å‰è€…ï¼ŒIntel èŠ¯ç‰‡é€‰æ‹©åè€…ã€‚ç¤ºä¾‹ä»£ç çš„è¿è¡Œç¯å¢ƒæ˜¯ M1 èŠ¯ç‰‡çš„ç”µè„‘ï¼Œæ‰€ä»¥ä½¿ç”¨å‰è€…ï¼Œå¦‚æœè¯»è€…ä½¿ç”¨çš„æ˜¯ Intel CPUï¼Œè¯·å°†å‘½ä»¤ä¸­çš„ triple æ›¿æ¢æˆ `x86_64-apple-darwin`ã€‚è¿›å…¥ _native_ ç›®å½•ï¼Œç¼–è¯‘ Rust ä»£ç ï¼š

```shell
cargo build --target aarch64-apple-darwin --release
```

ç¼–è¯‘åçš„æ–‡ä»¶ä½äº _target/TARGET_TRIPLE/release_ã€‚

### é…ç½® XCode

1. åœ¨ **Project Navigator** é€‰ä¸­ **Runner**
2. åˆ‡æ¢åˆ° **Build Phases** é¡µç­¾ï¼Œå±•å¼€ **Link Binary With Libraries**
3. æŠŠä¹‹å‰ç¼–è¯‘çš„ _target/aarch64-apple-darwin/release/libnative.so_ æ‹–åŠ¨åˆ°æ­¤åŒºåŸŸ
4. åˆ‡æ¢åˆ° **Build Settings** é¡µç­¾ï¼Œæ‰¾åˆ° **Library Search Paths**ï¼ŒåŒå‡»æ‰“å¼€ï¼Œå¹¶æ‹–å…¥ _target/aarch64-apple-darwin/release_ æ–‡ä»¶å¤¹

### è¿è¡Œ

æ‰§è¡Œ `flutter run -d macos` å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç”»é¢ï¼š

<img
  src="/static/images/rust/hybrid-rust-and-flutter/run-on-macos.png"
  width="400px"
  alt="run on macos"
/>

## é…ç½® Windowsã€Linux é¡¹ç›®\*\*

\*\*
Windows å’Œ Linux éƒ½æ˜¯é€šè¿‡ CMake é›†æˆï¼Œæ­¥éª¤å®Œå…¨ä¸€æ ·ï¼Œä¸‹æ–‡ä»¥ Windows ä¸ºä¾‹ã€‚

### ç¼–è¯‘ Rust ä»£ç 

ä¸º Rust æ·»åŠ  Windows çš„ç¼–è¯‘ç›®æ ‡ï¼š

```shell
rustup target add x86_64-pc-windows-msvc
```

ç¼–è¯‘ä»£ç ï¼š

```shell
cargo build --target x86_64-pc-windows-msvc --release
```

ç¼–è¯‘åçš„æ–‡ä»¶ä½äº _target/x86_64-pc-windows-msvc/release_ã€‚

### é…ç½® CMake

[corrosion](https://github.com/corrosion-rs/corrosion) å·¥å…·ç”¨äºå°† Rust Crate é›†æˆè¿› CMakeã€‚ä¸‹è½½ [rust.cmake](https://raw.githubusercontent.com/Desdaemon/flutter_rust_bridge_template/main/windows/rust.cmake) åˆ° windows ç›®å½•ï¼Œæ‰“å¼€ _CMakeLists.txt_ï¼Œåœ¨ `include(flutter/generated_plugins.cmake)` ä¸‹æ·»åŠ ä¸€è¡Œï¼š

```cmake
include(./rust.cmake)
```

### è¿è¡Œ

æ‰§è¡Œ `flutter run -d windows` å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç”»é¢ï¼š

<img
  src="/static/images/rust/hybrid-rust-and-flutter/run-on-windows.png"
  width="400px"
  alt="run on windows"
/>

## é…ç½® Web ç«¯

Rust å¯ä»¥é€šè¿‡ç¼–è¯‘æˆ WebAssembly æ”¯æŒ Web å¹³å°ï¼Œä½¿ç”¨çš„å·¥å…·æ˜¯ [wasm-pack](https://rustwasm.github.io/wasm-pack/)ï¼Œå…ˆå®‰è£…å·¥å…·ï¼š

```shell
cargo install wasm-pack
```

ä¸ºäº†æ”¯æŒ WebAssemblyï¼Œéœ€è¦å¯¹ Rust é¡¹ç›®è¿›è¡Œä¸€äº›ä¿®æ”¹ã€‚å¦å¤–ï¼Œè™½ç„¶å¯ä»¥ç»§ç»­æ²¿ç”¨ä¸Šé¢ä½¿ç”¨çš„ Flutter é¡¹ç›®ï¼Œä½†æ˜¯è¿™éœ€è¦æ¶é€š Flutter å’Œ HTML/JavaScript çš„æ¡¥æ¢ï¼Œä¼šå ç”¨ä¸å°çš„ç¯‡å¹…ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„ç›®çš„ï¼Œä¸‹é¢æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ HTML/JavaScript å®Œæˆ `md5()` è°ƒç”¨ã€‚

### ä¿®æ”¹ Rust ä»£ç 

é¦–å…ˆå¼•å…¥ [`wasm-bindgen`](https://crates.io/crates/wasm_bindgen) crateï¼Œå®ƒå°†å…è®¸ä»£ç ä¸­ä½¿ç”¨ `wasm_bindgen` å±æ€§ï¼Œç”¨äºæ ‡è®°é‚£äº›åº”è¯¥æš´éœ²åœ¨ WASM æ¨¡å—ä¸­çš„æ¥å£ã€‚

```shell
cargo add wasm-bindgen
```

æ‰“å¼€ _api.rs_ æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```rust
#[wasm_bindgen]
pub fn md5_string(data: &str) ->String {
    let digest = md5::compute(data);
    format!("{:x}", digest)
}
```

ä¸ºéœ€è¦å¯¼å‡ºå‡½æ•°æ·»åŠ  `wasm_bindgen` å±æ€§ã€‚ä¸ºäº†å¯¼å‡º WASM å’Œ FFIï¼Œç°åœ¨æœ‰äº›é‡å¤çš„ä»£ç ï¼Œè€Œä¸”å¹¶æ²¡æœ‰å®Œå…¨åšåˆ°ä¸€å¥—ä»£ç ï¼Œå…¨ç«¯é€šç”¨ã€‚è¿™äº›é—®é¢˜ç°åœ¨ä¸æ˜¯é‡ç‚¹ï¼Œ**åœ¨å·¥å…·é“¾çš„å¸®åŠ©ä¸‹ï¼Œè¿™äº›å·®å¼‚æ€§éƒ½å¯ä»¥æ¶ˆé™¤**ï¼Œæ›´å¤šç»†èŠ‚å‚è§ [flutter_rust_bridge](https://cjycode.com/flutter_rust_bridge/)ã€‚

è¿›å…¥ _native_ ç›®å½•è¿è¡Œå‘½ä»¤ç”Ÿæˆ WASM æ–‡ä»¶ï¼š

```shell
wasm-pack build
```

ç”Ÿæˆçš„æ–‡ä»¶ä½äº _native/pkg_ ç›®å½•ä¸‹ï¼Œé™¤äº† wasm æ–‡ä»¶ï¼Œ`wasm-pack` è¿˜å¸®æˆ‘ä»¬ç”Ÿæˆäº†ä»¥ä¸‹æ–‡ä»¶ï¼š

1. _\*.js_ï¼šRust å¯¼å‡ºçš„ API çš„ JavaScript å°è£…ï¼Œå’Œä¸Šæ–‡ä¸­ cbindgen çš„ä½œç”¨ç±»ä¼¼ã€‚
2. _\*.d.ts_ï¼šç”¨äº TypeScriptã€‚ä» _native_bg.wasm.d.ts_ è¿˜èƒ½çœ‹åˆ° WASM æ–‡ä»¶ä¸­å¯¼å‡ºäº† `memory` APIï¼Œæ›´å¤šå†…å®¹å‚è§ [Rust ä¸ Dart çš„æ•°æ®äº¤äº’](./dart-rust-interop)ã€‚
3. _\*.wasm_ï¼šRust ç¼–è¯‘äº§ç‰©ã€‚
4. _package.json_ï¼šnpm åŒ…é…ç½®æ–‡ä»¶ã€‚

### åˆ›å»º HTML é¡¹ç›®

HTML é¡¹ç›®å°†ä½¿ç”¨ [create-wasm-app](https://github.com/rustwasm/create-wasm-app) æ¨¡æ¿ï¼Œåœ¨ _native_ ç›®å½•ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ HTML é¡¹ç›®ï¼š

```shell
npm init wasm-app web
# è¿›å…¥ web ç›®å½•
cd web
# å®‰è£…ä¾èµ–
npm i
# æ‰“å¼€å¼€å‘æœåŠ¡å™¨
npm start
```

æ‰“å¼€å¼€å‘æœåŠ¡å™¨åï¼Œç»ˆç«¯ä¼šæ‰“å°å‡ºå¼€å‘åœ°å€ï¼Œé»˜è®¤ä¸º `http://localhost:8080`ï¼Œæ‰“å¼€åï¼Œè¯¥æ¨¡æ¿é»˜è®¤ä¼šå¼¹å‡ºä¸€ä¸ª `alert`ã€‚

è¿›å…¥ _native/pkg_ ç›®å½•ï¼Œæ‰§è¡Œ `npm link`ï¼Œç”±äºè¿™ä¸ªç›®å½•ä¸‹æœ‰ _package.json_ æ–‡ä»¶ï¼Œä½¿å¾—å½“å‰ç›®å½•ä¸‹çš„ npm åŒ…å¯ä»¥è¢«å…¶ä»–æœ¬åœ° npm åŒ…ä½œä¸ºä¾èµ–ã€‚

å›åˆ° _native/web_ ç›®å½•ï¼Œæ‰§è¡Œ `npm link native` é“¾æ¥ä¸Šä¸€æ­¥çš„åŒ…ï¼Œå…¶ä¸­ `native` å°±æ˜¯ _native/pkg/package.json_ é‡Œçš„ `name` å­—æ®µå€¼ã€‚

ä¿®æ”¹ _native/web/index.js_ æ–‡ä»¶ï¼Œåˆ é™¤æ‰€æœ‰ä»£ç ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```js
import * as wasm from 'native'
document.body.innerText = wasm.md5_string('hello world')
```

### è¿è¡Œ

åœ¨ä¸Šä¸€èŠ‚å¼€å‘æœåŠ¡å™¨å·²ç»è¢«æ‰“å¼€äº†ï¼Œåˆ‡æ¢åˆ°ä¹‹å‰æ‰“å¼€çš„ç½‘é¡µï¼Œæ­¤æ—¶å®ƒåº”è¯¥è‡ªåŠ¨åˆ·æ–°äº†ï¼Œå¹¶åœ¨ç½‘é¡µä¸Šæ˜¾ç¤ºä¸€ä¸²å­—ç¬¦ä¸² `5eb63bbbe01eeed093cb22bb8f5acdc3`ã€‚

<img
  alt="run on web"
  src="/static/images/rust/hybrid-rust-and-flutter/run-on-web.png"
  width="400px"
/>

## å†…å­˜é—®é¢˜

ä¸Šæ–‡æˆ‘ä»¬å®Œæˆäº† Rust åœ¨å¸¸è§ App å‘è¡Œå¹³å°çš„é›†æˆå’Œè¿è¡Œï¼Œå®é™…ä¸Šç°åœ¨çš„ä»£ç æœ‰äº›é—®é¢˜ã€‚

md5 è®¡ç®—æ˜¯ Rust æä¾›çš„ï¼Œå®ƒçš„å†…å­˜ä¹Ÿæ˜¯åœ¨ Rust åˆ†é…çš„ï¼Œä¸€æ—¦æ•°æ®ä½¿ç”¨ `CString.into_raw` ä¼ é€’åˆ°å¤–éƒ¨ï¼ŒRust å°±ä¸å†è‡ªåŠ¨ç®¡ç†å®ƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ‰€ä»¥éœ€è¦ä¸‹é¢è¿™æ ·ä¸€ä¸ªé‡Šæ”¾å‡½æ•°ï¼š

```rust
#[no_mangle]
pub extern "C" fn free_string(ptr: *mut c_char) {
    unsafe { drop(CString::from_raw(ptr)); }
}
```

åœ¨ Dart å¯ä»¥è¿™æ ·å°è£…:

```dart
static freeString(String value) {
    _bindings.free_string(value.toNativeUtf8().cast<Char>());
}
```

é€šè¿‡å°† `md5()` è¿”å›çš„å­—ç¬¦ä¸²ä¼ é€’ç»™ `freeString()` å³å¯ã€‚æ›´å¤šç»†èŠ‚å‚è§ [Rust ä¸ Dart çš„æ•°æ®äº¤äº’](./dart-rust-interop)ã€‚

---

## å‚è€ƒèµ„æ–™

1. [Rust std::ffi](https://doc.rust-lang.org/std/ffi/index.html)
1. [C interop using dart:ffi](https://dart.dev/guides/libraries/c-interop)
1. [flutter_rust_bridge](https://cjycode.com/flutter_rust_bridge/index.html)
1. [Building and Deploying a Rust library on Android](https://mozilla.github.io/firefox-browser-architecture/experiments/2017-09-21-rust-on-android.html)
1. [cbindgen](https://docs.rs/crate/cbindgen/latest)
1. [Use the NDK with other build systems](https://developer.android.com/ndk/guides/other_build_systems)
1. [corrosion](https://github.com/corrosion-rs/corrosion)
1. [wasm-pack docs](https://rustwasm.github.io/wasm-pack/book/introduction.html)
1. [Rust ğŸ¦€ å’Œ WebAssembly ğŸ•¸](https://llever.com/rustwasm-book/)
